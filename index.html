<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Goonies Trip Treasure Map (VHS)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --ink:#2a1d12;
      --paper:#f1e3c6;
      --paper2:#e8d3a8;
      --shadow: rgba(0,0,0,.25);
      --red:#b00000;
      --vhs-green:#22ff88;
      --vhs-white:#f3f3f3;
      --vhs-black:#0a0a0a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 20% 10%, #2b2b2b 0%, #121212 55%, #0b0b0b 100%);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }

    header{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .title h1{ margin:0; font-size:clamp(22px,3vw,34px); letter-spacing:.4px; }
    .title .sub{ font-size:14px; opacity:.9; margin-top:6px; max-width: 760px; }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    button{
      border:0; padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:900;
      box-shadow:0 8px 20px var(--shadow);
      background:linear-gradient(180deg,#f7e8c9,#e3cfa5);
      color: var(--ink);
    }
    button.secondary{
      background:linear-gradient(180deg,#1f1f1f,#121212);
      color:#f5e9d2;
      border: 1px solid rgba(255,255,255,.12);
    }

    .grid{ display:grid; grid-template-columns:1.4fr .6fr; gap:14px; }
    @media(max-width:920px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border-radius:18px; overflow:hidden;
      box-shadow:0 18px 45px var(--shadow);
      border:1px solid rgba(255,255,255,.1);
    }

    /* Treasure parchment base under the map */
    .mapShell{
      position:relative;
      background:
        radial-gradient(600px 320px at 20% 10%, rgba(255,255,255,.4), transparent 55%),
        linear-gradient(135deg,var(--paper),var(--paper2));
    }
    .mapShell::after{
      content:""; pointer-events:none;
      position:absolute; inset:0;
      background:
        radial-gradient(900px 520px at 50% 30%, rgba(0,0,0,0) 55%, rgba(0,0,0,.35) 100%),
        repeating-linear-gradient(0deg, rgba(0,0,0,.03), rgba(0,0,0,.03) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 6px);
      mix-blend-mode:multiply;
      opacity:.55;
    }

    /* VHS stage holds map + overlay */
    .vhsStage{
      position:relative;
      height:620px;
      width:100%;
      overflow:hidden;
      border-radius:18px;
      transform: translateZ(0);
    }
    #map{
      height:620px;
      width:100%;
      /* base “aged map” tone */
      filter: sepia(.55) contrast(1.05) saturate(.9);
    }
    @media(max-width:920px){
      .vhsStage, #map{ height:520px; }
    }

    /* --- VHS Overlay Effects --- */
    .vhsOverlay{
      pointer-events:none;
      position:absolute; inset:0;
      opacity:.85;
      mix-blend-mode: overlay;
    }

    /* Scanlines */
    .vhsOverlay::before{
      content:"";
      position:absolute; inset:-30px;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,.20) 0px,
          rgba(0,0,0,.20) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 6px
        );
      opacity:.35;
      transform: translateY(0);
      animation: scanMove 8s linear infinite;
    }

    /* Noise + vignette */
    .vhsOverlay::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(800px 460px at 50% 30%, rgba(0,0,0,0) 60%, rgba(0,0,0,.55) 100%),
        radial-gradient(700px 420px at 10% 20%, rgba(255,255,255,.07), rgba(255,255,255,0) 60%),
        radial-gradient(900px 520px at 90% 80%, rgba(255,255,255,.05), rgba(255,255,255,0) 55%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px);
      opacity:.55;
      filter: contrast(1.05);
      animation: noiseFlicker .25s steps(2) infinite;
    }

    /* Chromatic aberration (subtle) */
    .vhsChrom{
      pointer-events:none;
      position:absolute; inset:0;
      mix-blend-mode: screen;
      opacity:.22;
      filter: blur(.25px);
    }
    .vhsChrom.red{
      transform: translateX(1px);
      background: rgba(255,0,70,.10);
    }
    .vhsChrom.cyan{
      transform: translateX(-1px);
      background: rgba(0,255,255,.08);
    }

    /* Tracking wobble: gently shifts the whole stage */
    .vhsWobble{
      animation: wobble 6.5s ease-in-out infinite;
      transform-origin: center;
    }

    /* Timestamp / REC */
    .vhsHud{
      pointer-events:none;
      position:absolute; inset:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: var(--vhs-white);
      text-shadow: 0 0 8px rgba(0,0,0,.65);
    }
    .vhsHud .topLeft{
      position:absolute; left:14px; top:12px;
      display:flex; gap:10px; align-items:center;
      font-weight:800;
      opacity:.9;
    }
    .vhsDot{
      width:10px; height:10px; border-radius:50%;
      background:#ff2a2a;
      box-shadow: 0 0 12px rgba(255,40,40,.7);
      animation: recBlink 1s steps(2) infinite;
    }
    .vhsHud .topRight{
      position:absolute; right:14px; top:12px;
      font-weight:800;
      opacity:.9;
    }
    .vhsHud .bottomLeft{
      position:absolute; left:14px; bottom:14px;
      font-weight:800;
      color: var(--vhs-green);
      opacity:.9;
      letter-spacing:.3px;
    }

    @keyframes scanMove{
      0%{ transform: translateY(0); }
      100%{ transform: translateY(28px); }
    }
    @keyframes noiseFlicker{
      0%{ opacity:.52; }
      50%{ opacity:.62; }
      100%{ opacity:.50; }
    }
    @keyframes wobble{
      0%{ transform: translateX(0px) skewX(0deg); }
      20%{ transform: translateX(.6px) skewX(.08deg); }
      50%{ transform: translateX(-.8px) skewX(-.10deg); }
      80%{ transform: translateX(.4px) skewX(.06deg); }
      100%{ transform: translateX(0px) skewX(0deg); }
    }
    @keyframes recBlink{
      0%, 49%{ opacity:1; }
      50%, 100%{ opacity:.25; }
    }

    /* Sidebar */
    .side{ background:linear-gradient(180deg,#f7ebd2,#e6d2ab); padding:14px; }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-bottom:10px; font-size:13px; opacity:.95;
    }
    .pill{
      font-size:11px; font-weight:950; padding:4px 8px;
      border-radius:999px; background: rgba(0,0,0,.08);
      white-space:nowrap;
    }
    .spot{
      padding:10px; border-radius:14px;
      background:rgba(255,255,255,.55);
      margin-bottom:10px; cursor:pointer;
      border:1px solid rgba(0,0,0,.1);
      box-shadow:0 10px 24px rgba(0,0,0,.12);
    }
    .spot .name{
      font-weight: 950;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .spot .meta{ font-size:12px; opacity:.85; margin-top:4px; }
    .spot.visited .name{
      text-decoration:line-through;
      text-decoration-thickness:3px;
      text-decoration-color: var(--red);
    }
    .rowBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .rowBtns button{ padding:8px 10px; border-radius:12px; box-shadow:none; }
    .rowBtns button.secondary{ border: 1px solid rgba(0,0,0,.12); }

    /* Big pirate X marker */
    .pirateX{
      width: 46px;
      height: 46px;
      transform: rotate(-10deg);
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.25));
    }
    .pirateX line{
      stroke: #b00000;
      stroke-width: 8;
      stroke-linecap: round;
    }
    .pirateX circle{
      stroke: rgba(176,0,0,.45);
      stroke-width: 3;
      fill: none;
    }

    /* Photo modal + VHS aesthetic */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .modal{
      position:relative;
      background: linear-gradient(180deg, #1b1b1b, #0f0f0f);
      border-radius:18px;
      padding:14px;
      max-width:900px;
      width:min(900px, 100%);
      box-shadow:0 22px 70px rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color: #f2f2f2;
      overflow:hidden;
    }
    .modalHeader{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modalHeader h2{ margin:0; font-size: 20px; letter-spacing:.3px; }
    .modalHeader .subline{ font-size:12px; opacity:.75; margin-top:4px; font-weight:700; }
    .modal button.secondary{
      box-shadow:none;
      background: linear-gradient(180deg, #2a2a2a, #121212);
      border: 1px solid rgba(255,255,255,.12);
      color: #f3f3f3;
    }

    .photoStage{
      position:relative;
      border-radius:14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: #000;
    }
    .photoStage img{
      width:100%;
      display:block;
      /* VHS-y color + slight blur */
      filter: contrast(1.05) saturate(1.15) hue-rotate(-3deg) blur(.3px);
      transform: scale(1.01);
    }
    .photoOverlay{
      pointer-events:none;
      position:absolute; inset:0;
      opacity:.9;
      mix-blend-mode: overlay;
    }
    .photoOverlay::before{
      content:"";
      position:absolute; inset:-20px;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,.28) 0px,
        rgba(0,0,0,.28) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 6px
      );
      opacity:.40;
      animation: scanMove 7s linear infinite;
    }
    .photoOverlay::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(800px 460px at 50% 30%, rgba(0,0,0,0) 55%, rgba(0,0,0,.65) 100%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 5px);
      opacity:.65;
      animation: noiseFlicker .22s steps(2) infinite;
    }

    .photoHud{
      pointer-events:none;
      position:absolute; inset:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      text-shadow: 0 0 10px rgba(0,0,0,.75);
    }
    .photoHud .tl{
      position:absolute; left:12px; top:10px;
      display:flex; gap:10px; align-items:center;
      font-weight:900;
    }
    .photoHud .br{
      position:absolute; right:12px; bottom:10px;
      font-weight:900;
      color: var(--vhs-green);
      opacity:.92;
    }
  </style>
</head>

<body>
<div class="wrap">

<header>
  <div class="title">
    <h1>Goonies Trip Treasure Map</h1>
    <div class="sub">
      VHS mode is ON. Pins don’t auto-cross when clicked — use <b>Cross Off</b>. Crossed stops get a big pirate red “X”.
    </div>
  </div>
  <div class="btnrow">
    <button id="fitBtn" class="secondary">Fit Map</button>
    <button id="resetBtn">Reset</button>
  </div>
</header>

<div class="grid">
  <div class="card mapShell">
    <div class="vhsStage vhsWobble">
      <div id="map"></div>

      <!-- VHS overlays -->
      <div class="vhsChrom red"></div>
      <div class="vhsChrom cyan"></div>
      <div class="vhsOverlay"></div>

      <!-- HUD -->
      <div class="vhsHud">
        <div class="topLeft"><span class="vhsDot"></span> REC</div>
        <div class="topRight">SP</div>
        <div class="bottomLeft" id="vhsTime">00:00:00</div>
      </div>
    </div>
  </div>

  <div class="card side">
    <div class="legend">
      <span class="pill">Click a stop in the list to zoom + open its popup</span>
    </div>
    <div id="spotList"></div>
  </div>
</div>

</div>

<!-- Photo Modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <h2 id="modalTitle">Photo</h2>
        <div class="subline" id="modalMeta"></div>
      </div>
      <button class="secondary" onclick="closeModal()">Close</button>
    </div>

    <div class="photoStage">
      <img id="modalImg" alt="Location photo" />

      <!-- Photo VHS overlays -->
      <div class="photoOverlay"></div>
      <div class="photoHud">
        <div class="tl"><span class="vhsDot"></span> PLAY</div>
        <div class="br" id="photoStamp">00:00:00</div>
      </div>
    </div>
  </div>
</div>

<script>
  // ---- Locations + images (repo root, all .jpg) ----
  const SPOTS = [
    {
      id:"oregon_film_museum",
      name:"Oregon Film Museum (County Jail)",
      meta:"732 Duane St, Astoria",
      lat:46.188499, lng:-123.835579,
      image:"CountyJail.jpg"
    },
    {
      id:"haystack_rock",
      name:"Haystack Rock",
      meta:"Cannon Beach",
      lat:45.88438, lng:-123.96841,
      image:"haystackrock.jpg"
    },
    {
      id:"lighthouse_lounge",
      name:"Lighthouse Lounge (set location area)",
      meta:"Ecola State Park area",
      lat:45.9310, lng:-123.9783,
      image:"LighthouseLounge.jpg"
    },
    {
      id:"lower_columbia_bowl",
      name:"Lower Columbia Bowl",
      meta:"826 Marine Dr, Astoria",
      lat:46.190063, lng:-123.834503,
      image:"bowlingalley.jpg"
    },
    {
      id:"goonies_house",
      name:"Goonies Main House",
      meta:"368 38th St, Astoria",
      lat:46.192848, lng:-123.799767,
      image:"house.jpg"
    },
    {
      id:"astoria_coffee_company",
      name:"Astoria Coffee Company Building",
      meta:"Leif Erikson Dr & 37th St",
      lat:46.193310, lng:-123.801842,
      image:"street.jpg"
    }
  ];

  // ---- Persistence ----
  const STORAGE_KEY="goonies_crossed_v7";
  let crossed = (() => {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  })();
  const saveCrossed = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(crossed));

  // ---- Map init ----
  const map = L.map("map");
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ---- Big pirate X icon ----
  function pirateXIcon(){
    const svg = `
      <svg class="pirateX" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <circle cx="32" cy="32" r="28"></circle>
        <line x1="18" y1="18" x2="46" y2="46"></line>
        <line x1="46" y1="18" x2="18" y2="46"></line>
      </svg>
    `;
    return L.divIcon({
      className: "",
      html: svg,
      iconSize: [46, 46],
      iconAnchor: [23, 23]
    });
  }

  // A subtle “not crossed” icon
  function todoIcon(){
    return L.divIcon({
      className: "",
      html: `<div style="
        width:28px;height:28px;border-radius:10px;
        display:flex;align-items:center;justify-content:center;
        background:#111;color:#f7ebd2;font-weight:900;
        box-shadow:0 10px 25px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.25);
      ">✦</div>`,
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });
  }

  const markers = new Map();
  const bounds = [];

  function setMarkerIcon(id){
    const marker = markers.get(id);
    if (!marker) return;
    marker.setIcon(crossed[id] ? pirateXIcon() : todoIcon());
  }

  function toggleCrossOff(id){
    crossed[id] = !crossed[id];
    saveCrossed();
    setMarkerIcon(id);
    renderList();
  }

  // ---- Photo modal ----
  function openPhoto(id){
    const spot = SPOTS.find(s => s.id === id);
    if (!spot) return;
    document.getElementById("modalTitle").innerText = spot.name;
    document.getElementById("modalMeta").innerText = spot.meta;
    document.getElementById("modalImg").src = spot.image;
    document.getElementById("modalBack").style.display = "flex";
  }
  function closeModal(){
    document.getElementById("modalBack").style.display = "none";
  }
  window.closeModal = closeModal;
  window.openPhoto = openPhoto;

  document.getElementById("modalBack").addEventListener("click", (e) => {
    if (e.target.id === "modalBack") closeModal();
  });

  // ---- Add markers ----
  SPOTS.forEach(spot => {
    const marker = L.marker([spot.lat, spot.lng], {
      icon: crossed[spot.id] ? pirateXIcon() : todoIcon(),
      title: spot.name
    }).addTo(map);

    markers.set(spot.id, marker);
    bounds.push([spot.lat, spot.lng]);

    // IMPORTANT: marker click does NOT toggle (just opens popup)
    marker.bindPopup(makePopupHtml(spot));
  });

  function makePopupHtml(spot){
    const done = !!crossed[spot.id];
    return `
      <div style="font-weight:950;margin-bottom:4px;">${escapeHtml(spot.name)}</div>
      <div style="font-size:12px;opacity:.9;margin-bottom:10px;">${escapeHtml(spot.meta)}</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button
          style="border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:950;background:#2b2b2b;color:#f7ebd2;"
          onclick="openPhoto('${spot.id}')"
        >Photo</button>
        <button
          style="border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:950;background:#8b1c1c;color:#f7ebd2;"
          onclick="toggleCrossOffPublic('${spot.id}')"
        >${done ? "Un-cross" : "Cross Off"}</button>
      </div>
    `;
  }

  // Expose for popup buttons
  window.toggleCrossOffPublic = (id) => {
    toggleCrossOff(id);
    // If popup is open, refresh its HTML so button label updates immediately
    const marker = markers.get(id);
    const spot = SPOTS.find(s => s.id === id);
    if (marker && spot && marker.isPopupOpen()){
      marker.setPopupContent(makePopupHtml(spot));
    }
  };

  map.fitBounds(bounds, { padding: [30, 30] });
  document.getElementById("fitBtn").onclick = () => map.fitBounds(bounds, { padding: [30, 30] });

  document.getElementById("resetBtn").onclick = () => {
    crossed = {};
    saveCrossed();
    SPOTS.forEach(s => setMarkerIcon(s.id));
    renderList();
  };

  // ---- Sidebar list ----
  function renderList(){
    const list = document.getElementById("spotList");
    list.innerHTML = "";

    SPOTS.forEach(spot => {
      const done = !!crossed[spot.id];

      const div = document.createElement("div");
      div.className = "spot" + (done ? " visited" : "");

      div.innerHTML = `
        <div class="name">
          <span>${escapeHtml(spot.name)}</span>
          <span class="pill">${done ? "CROSSED OFF" : "TO DO"}</span>
        </div>
        <div class="meta">${escapeHtml(spot.meta)}</div>
        <div class="rowBtns">
          <button class="secondary" onclick="event.stopPropagation(); openPhoto('${spot.id}')">Photo</button>
          <button onclick="event.stopPropagation(); toggleCrossOffPublic('${spot.id}')">
            ${done ? "Un-cross" : "Cross Off"}
          </button>
        </div>
      `;

      // Clicking list item zooms + opens popup (no toggle)
      div.addEventListener("click", () => {
        map.setView([spot.lat, spot.lng], Math.max(map.getZoom(), 13), { animate: true });
        const marker = markers.get(spot.id);
        if (marker){
          marker.openPopup();
          marker.setPopupContent(makePopupHtml(spot));
        }
      });

      list.appendChild(div);
    });
  }
  renderList();

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---- VHS timers ----
  function pad(n){ return String(n).padStart(2,"0"); }
  function tick(){
    const now = new Date();
    const t = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    const vhs = document.getElementById("vhsTime");
    const ph = document.getElementById("photoStamp");
    if (vhs) vhs.textContent = t;
    if (ph) ph.textContent = t;
  }
  tick();
  setInterval(tick, 1000);
</script>
</body>
</html>
